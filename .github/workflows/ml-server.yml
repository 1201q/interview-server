name: ml-server

on:
  push:
    branches: ["main"]
    paths:
      - "ml-server/**"
      - ".github/workflows/ml-server.yml"

jobs:
  build-and-push-ml:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # ìµœì‹ 

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push ML Image (ARM native)
        uses: docker/build-push-action@v6 # ìµœì‹ 
        with:
          context: ./ml-server
          file: ./ml-server/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ml-server:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/ml-server:arm64
          cache-from: type=gha # GHA ìºì‹œë¡œ ì „í™˜
          cache-to: type=gha,mode=max
          provenance: false #  ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒëµí•´ ì•½ê°„ ë‹¨ì¶•

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push-ml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml, nginx.conf"
          target: /home/ubuntu/interview
          overwrite: true
          debug: true

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/ubuntu/interview
            echo "PY_TEST=${{ secrets.PY_TEST }}" >> .env

            docker-compose stop ml-server ml-worker || true
            docker-compose rm -f ml-server ml-worker || true

            docker system prune -af

            echo "ğŸ“¦ ML ì´ë¯¸ì§€ pull"
            docker-compose pull ml-server ml-worker

            echo "ğŸš€ ML ì„œë²„ ì¬ì‹œì‘"
            docker-compose up -d --build ml-server ml-worker

            echo "âœ… ML ì„œë²„ ë°°í¬ ì™„ë£Œ!"
