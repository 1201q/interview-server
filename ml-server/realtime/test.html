<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whisper Live STT Demo</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        background-color: #f7f7f7;
      }
      #out {
        border: 1px solid #ccc;
        padding: 1rem;
        min-height: 100px;
        background: white;
        margin-bottom: 1rem;
        white-space: pre-wrap;
      }
      button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ™ï¸ Whisper ì‹¤ì‹œê°„ STT</h1>
    <div id="out">ì—¬ê¸°ì— ì¸ì‹ëœ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
    <button id="startBtn">ë…¹ìŒ ì‹œì‘</button>
    <button id="stopBtn" disabled>ë…¹ìŒ ì¢…ë£Œ</button>

    <script>
      let mediaRec, ws;
      let fullText = "";

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const output = document.getElementById("out");

      startBtn.onclick = async () => {
        ws = new WebSocket("ws://localhost:5000"); // WhisperLive ì„œë²„ ì£¼ì†Œ
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          console.log("WebSocket ì—°ê²°ë¨");
        };

        ws.onmessage = (e) => {
          const { text } = JSON.parse(e.data);
          fullText += text + " ";
          output.innerText = fullText.trim();
        };

        ws.onclose = () => {
          console.log("WebSocket ì¢…ë£Œë¨");
          callGPT(fullText.trim());
        };

        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        mediaRec = new MediaRecorder(stream, {
          mimeType: "audio/webm;codecs=opus",
        });

        mediaRec.ondataavailable = async (e) => {
          if (ws.readyState === WebSocket.OPEN) {
            const arrayBuffer = await e.data.arrayBuffer();
            ws.send(arrayBuffer);
          }
        };

        mediaRec.onstop = () => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.close();
          }
        };

        mediaRec.start(3000); // 3ì´ˆë§ˆë‹¤ chunk ì „ì†¡
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };

      stopBtn.onclick = () => {
        if (mediaRec && mediaRec.state !== "inactive") {
          mediaRec.stop();
        }
        stopBtn.disabled = true;
        startBtn.disabled = false;
      };

      async function callGPT(text) {
        if (!text || text.length < 3) {
          alert("ë¶„ì„í•  ë‚´ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return;
        }

        try {
          const res = await fetch("http://localhost:8000/api/gpt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ answer: text }),
          });

          const data = await res.json();

          if (data.result === "FOLLOW_UP") {
            alert("ê¼¬ë¦¬ì§ˆë¬¸: " + data.question);
          } else {
            alert("âœ… ì¶©ë¶„í•œ ë‹µë³€ì…ë‹ˆë‹¤.");
          }
        } catch (err) {
          alert("GPT ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨");
          console.error(err);
        }
      }
    </script>
  </body>
</html>
